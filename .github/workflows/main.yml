# Builds using docker
---
name: Build

on: 
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build:
    strategy:
      matrix:
        python: [3.9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
      - name: Add variable
        run: |
          run: |
            echo "COMPOSE_FILE=docker-compose.yml:volumes.yml" >> $GITHUB_PATH
      - name: Set up
        run: |
          mkdir /tmp/omero-app
          cp -r . /tmp/omero-app/.omero
      - name: Build
        run: |
          cd /tmp/omero-app
          .omero/compose up -d
          echo "üê≥ whale check üê≥"
          docker ps
      - name: Wait for Ontop service to be available
        run: |
          for i in {1..10}; do
            curl --silent --fail http://0.0.0.0:8080/ && break
            echo "Waiting for Ontop service..."
            sleep 10
          done
      - name: Run tests
        run: |
          echo "test sweet üçå"
          pip install rdflib requests pytest
          curl "http://0.0.0.0:8080/sparql/?query=PREFIX%20ome_core%3A%20%3Chttp%3A%2F%2Fwww.openmicroscopy.org%2Frdf%2F2016-06%2Fome_core%2F%3E%0ASELECT%20DISTINCT%20%3Fs%20%3Ftag%20WHERE%20%7B%0A%20%20%20%20%3Fs%20a%20ome_core%3AImage%3B%0A%20%20%20%20%20%20%20%20ome_core%3AtagAnnotationValue%20%3Ftag.%0A%7D"
          echo "after curl üçå"
          pytest --disable-warnings -v -s
      - name: Build-continuation
        run: |
          cd /tmp/omero-app
          .omero/compose down
          .omero/persist.sh backup
          .omero/persist.sh --restore backup
