# Builds using docker
---
name: Build

on: 
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build:
    strategy:
      matrix:
        python: [3.9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
      - name: Add variable
        run: |
          run: |
            echo "COMPOSE_FILE=docker-compose.yml:volumes.yml" >> $GITHUB_PATH
      - name: Set up
        run: |
          mkdir /tmp/omero-app
          cp -r . /tmp/omero-app/.omero
      - name: Build
        run: |
          cd /tmp/omero-app
          .omero/compose up -d
          echo "üê≥ whale check üê≥"
          docker ps
      - name: Wait for Ontop service to be available
        run: |
          for i in {1..10}; do
            curl --silent --fail http://0.0.0.0:8080/ && break
            echo "Waiting for Ontop service..."
            sleep 10
          done
      - name: Run tests
        run: |
          echo "test sweet üçå"
          pip install rdflib requests
          python -m unittest discover -s tests
          python tests/unit_test.py 
      - name: Build-continuation
        run: |
          cd /tmp/omero-app
          .omero/compose down
          .omero/persist.sh backup
          .omero/persist.sh --restore backup
      # - name: Check running containers
      #   run: docker ps
      # - name: Test Ontop SPARQL service
      #   run: |
      #     docker-compose exec ontop curl "http://localhost:8080/sparql?query=SELECT+%2A+WHERE+%7B+%3Fs+%3Fp+%3Fo+%7D+LIMIT+10"

      # - name: Test
      #   run: |
      #     curl "http://localhost:8080/sparql?query=SELECT+%2A+WHERE+%7B+%3Fs+%3Fp+%3Fo+%7D+LIMIT+10"
